---
layout: post
title: VSCode JTAG Debugging of ESP32 - Part 3
date: '2017-06-09T13:28:00.001-07:00'
author: gojimmypi
tags: 
modified_time: '2017-06-09T17:24:41.135-07:00'
thumbnail: https://3.bp.blogspot.com/-qaRW6jDNFHY/WTr_wv0xXqI/AAAAAAAAAcA/Wzq1uv8uO9cjq7ixJFcCzSwwXnAY3x7PQCLcB/s72-c/menu_config_FreeRTOS.PNG
blogger_id: tag:blogger.com,1999:blog-4109066286647243251.post-7553493991623549327
blogger_orig_url: https://gojimmypi.blogspot.com/2017/06/vscode-jtag-debugging-of-esp32-part-3.html
---

(see also&nbsp;<a href="{{ site.baseurl }}{% post_url 2017-03-17-jtag-debugging-for-esp32 %}">hardware setup</a>,&nbsp;<a href="{{ site.baseurl }}{% post_url 2017-05-25-vscode-jtag-debugging-of-esp32-part-1 %}">part 1</a>, and&nbsp;<a href="{{ site.baseurl }}{% post_url 2017-05-25-vscode-remote-jtag-debugging-of-esp32 %}">part 2</a>)<br /><br />Test drive of OpenOCD WIP branch with VSCode. See:&nbsp;<a href="https://github.com/espressif/openocd-esp32/wiki/Work-in-progress-ESP32-dual-core-target">https://github.com/espressif/openocd-esp32/wiki/Work-in-progress-ESP32-dual-core-target</a><br /><br />If there's already an openocd-esp32 checked out, save it: <br /><pre><code>cd ~/workspace<br />mv openocd-esp32 openocd-esp32-master<br /></code></pre><br />Fetch the WIP branch<br /><pre><code>cd ~/workspace<br />git clone -b feature/esp32_dualcore  --recursive https://github.com/espressif/openocd-esp32.git<br />cd openocd-esp32<br />git status<br /></code></pre>then follow instructions&nbsp;<a href="https://github.com/espressif/openocd-esp32">https://github.com/espressif/openocd-esp32</a><br /><pre><code>./bootstrap <br />./configure <br />make<br />sudo make install<br /></code></pre><br />Modified esp32_dc.cfg to esp32_dcx.cfg  <br /><pre><code><br />cp  /./home/gojimmypi/workspace/openocd-esp32/esp32_dc.cfg /./home/gojimmypi/workspace/openocd-esp32/esp32_dcx.cfg<br /></code></pre>Mine looks like this: <br /><pre><code><br /># Example configuration file to hook up an ESP32 module or board to a JTAG<br /># adapter. Please modify this file to your local setup.<br /><br /># Include the configuration for the JTAG adapter.<br /># By default, DevKit-J is used.<br /># Later versions of DevKit-J are known as ESP-WROVER-KIT,<br /># they can work with the same configuration file.<br /># If you use a different interface, please edit this to include the<br /># configuration file of yours.<br /># source [find interface/ftdi/esp32_devkitj_v1.cfg]<br /><br /># The ESP32 only supports JTAG.<br />transport select jtag<br /><br /># The speed of the JTAG interface, in KHz. If you get DSR/DIR errors (and they<br /># do not relate to OpenOCD trying to read from a memory range without physical<br /># memory being present there), you can try lowering this.<br /># On DevKit-J, this can go as high as 20MHz if CPU frequency is 80MHz, or 26MHz<br /># if CPU frequency is 160MHz or 240MHz.<br />adapter_khz 1000<br /><br />#Source the ESP32 configuration file<br />source [find target/esp32_dc.cfg]<br /><br /># The TDI pin of ESP32 is also a bootstrap pin that selects the voltage the SPI flash<br /># chip runs at. When a hard reset happens (e.g. because someone switches the board off<br /># and on) the ESP32 will use the current TDI value as the bootstrap value because the<br /># JTAG adapter overrides the pull-up or pull-down resistor that is supposed to do the<br /># bootstrapping. These lines basically set the idle value of the TDO line to a<br /># specified value, therefore reducing the chance of a bad bootup due to a bad flash<br /># voltage greatly.<br /><br /># Enable this for 1.8V SPI flash<br />#esp32 flashbootstrap 1.8<br /># Enable this for 3.3V SPI flash<br />esp32 flashbootstrap 3.3<br /></code></pre><br />Note there's a discussion for&nbsp;<a href="https://github.com/espressif/openocd-esp32/issues/6">openocd-esp32/issues/6</a>&nbsp;that mentions the flash voltage in config file:<br /><blockquote class="tr_bq"><i>That depends on the module which is used on the dev board. Most WROOM modules use 3.3V flash, while WROVER modules use 1.8V flash.</i></blockquote><br />For a JTAG debugger, I'm using the Olimex (default file, see esp32 config for some settings). I could not get the default 20MHz to work, so lower this setting if there are problems. Sample above is using 1MHz, but I have been able to get 10MHz to work reliably. Actual max speed will depend on JTAG cable type characteristics (length, capacitance, shielding, etc)<br /><pre><code>#<br /># Olimex ARM-USB-OCD-H<br />#<br /># http://www.olimex.com/dev/arm-usb-ocd.html<br />#<br /><br />interface ft2232<br />ft2232_device_desc "Olimex OpenOCD JTAG ARM-USB-OCD-H"<br />ft2232_layout olimex-jtag<br />ft2232_vid_pid 0x15ba 0x002b</code></pre>Modified launch.json in VSCode (different from prior blog). Note changes as specified&nbsp;<a href="https://github.com/espressif/openocd-esp32/wiki/Work-in-progress-ESP32-dual-core-target">here</a>. But I omitted last line with single "c". <br /><pre><code>{<br />    "version": "0.2.0",<br />    "configurations": [<br />        {<br />            "name": "OpenOCD Debug",<br />            "type": "cppdbg",<br />            "request": "launch",<br />            "miDebuggerPath": "C:/msys32/opt/xtensa-esp32-elf/bin/xtensa-esp32-elf-gdb.exe",<br />            "program": "Y:/home/gojimmypi/esp/hello_world/build/hello-world.elf",<br />            "setupCommands": [<br />                {<br />                    "description": "Enable pretty-printing for gdb",<br />                    "text": "-enable-pretty-printing",<br />                    "ignoreFailures": true<br />                },<br />                {<br />                    "text": "file 'Y:/home/gojimmypi/esp/hello_world/build/hello-world.elf'"<br />                },<br />                {<br />                    "text": "target remote 192.168.174.130:3333"<br />                },<br />                {<br />                    "text": "monitor reset halt"<br />                },<br />                {<br />                    "text": "thb app_main"<br />                },<br />                {<br />                    "text": "x $a1=0"<br />                }<br />            ],<br />            "externalConsole": false,<br />            "cwd": "Y:/home/gojimmypi/esp/hello_world/build/",<br />            "logging": {<br />                "trace": true,<br />                "traceResponse": true,<br />                "engineLogging": true<br />            }<br />        }<br />    ]<br />}<br /></code></pre>then launch OpenOCD <br /><pre><code>cd ~/workspace/openocd-esp32/tcl<br />sudo openocd -f interface/ftdi/olimex-arm-usb-ocd-h.cfg  -f ~/workspace/openocd-esp32/esp32_dcx.cfg<br /></code></pre>Output looks like this:  <br /><pre><code>Open On-Chip Debugger 0.10.0-dev-gc83a89c (2017-06-09-11:42)<br />Licensed under GNU GPL v2<br />For bug reports, read<br />        http://openocd.org/doc/doxygen/bugs.html<br />adapter speed: 1000 kHz<br />force hard breakpoints<br />Info : clock speed 1000 kHz<br />Info : JTAG tap: esp32.cpu0 tap/device found: 0x120034e5 (mfg: 0x272 (Tensilica), part: 0x2003, ver: 0x1)<br />Info : JTAG tap: esp32.slave tap/device found: 0x120034e5 (mfg: 0x272 (Tensilica), part: 0x2003, ver: 0x1)<br />Info : Target halted. PRO_CPU: PC=0x4008495D (active)    APP_CPU: PC=0x00000000<br /></code></pre><br />Note FreeRTOS change for app: Disable "Stop program on scheduler start..."<br /><pre><code>cd ~/esp/hello_world<br />export PATH=$PATH:$HOME/esp/xtensa-esp32-elf/bin<br />export IDF_PATH=~/esp/esp-idf<br />make menuconfig<br /></code></pre><div class="separator" style="clear: both; text-align: left;"><a href="https://3.bp.blogspot.com/-qaRW6jDNFHY/WTr_wv0xXqI/AAAAAAAAAcA/Wzq1uv8uO9cjq7ixJFcCzSwwXnAY3x7PQCLcB/s1600/menu_config_FreeRTOS.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="302" data-original-width="707" height="272" src="https://3.bp.blogspot.com/-qaRW6jDNFHY/WTr_wv0xXqI/AAAAAAAAAcA/Wzq1uv8uO9cjq7ixJFcCzSwwXnAY3x7PQCLcB/s640/menu_config_FreeRTOS.PNG" width="640" /></a></div><br />Rebuild and flash. Note I edited my Hello World to loop and not reset. <br /><pre><code>make clean<br />make<br />make flash<br /></code></pre>Ensure it is working: <br /><pre><code><br />make monitor<br /></code></pre>Output like this: <br /><pre><code><br />MONITOR<br />--- idf_monitor on /dev/ttyUSB0 115200 ---<br />--- Quit: Ctrl+] | Menu: Ctrl+T | Help: Ctrl+T followed by Ctrl+H ---<br />ets Jun  8 2016 00:22:57<br /><br />rst:0x1 (POWERON_RESET),boot:0x13 (SPI_FAST_FLASH_BOOT)<br />ets Jun  8 2016 00:22:57<br /><br />rst:0x10 (RTCWDT_RTC_RESET),boot:0x13 (SPI_FAST_FLASH_BOOT)<br />configsip: 0, SPIWP:0x00<br />clk_drv:0x00,q_drv:0x00,d_drv:0x00,cs0_drv:0x00,hd_drv:0x00,wp_drv:0x00<br />mode:DIO, clock div:2<br />load:0x3fff0008,len:8<br />load:0x3fff0010,len:4400<br />load:0x40078000,len:11092<br />ho 0 tail 12 room 4<br />load:0x40080000,len:252<br />0x40080000: _iram_start at ??:?<br /><br />entry 0x40080034<br />0x40080034: _iram_start at ??:?<br /><br />I (49) boot: ESP-IDF v2.0-rc1-854-gba55461 2nd stage bootloader<br />I (49) boot: compile time 13:14:19<br />I (49) boot: Enabling RNG early entropy source...<br />I (67) boot: SPI Speed      : 40MHz<br />I (79) boot: SPI Mode       : DIO<br />I (92) boot: SPI Flash Size : 4MB<br />I (104) boot: Partition Table:<br />I (115) boot: ## Label            Usage          Type ST Offset   Length<br />I (138) boot:  0 nvs              WiFi data        01 02 00009000 00006000<br />I (161) boot:  1 phy_init         RF data          01 01 0000f000 00001000<br />I (185) boot:  2 factory          factory app      00 00 00010000 00100000<br />I (208) boot: End of partition table<br />I (221) boot: Disabling RNG early entropy source...<br />I (238) boot: Loading app partition at offset 00010000<br />I (753) boot: segment 0: paddr=0x00010018 vaddr=0x00000000 size=0x0ffe8 ( 65512)<br />I (753) boot: segment 1: paddr=0x00020008 vaddr=0x3f400010 size=0x070ac ( 28844) map<br />I (769) boot: segment 2: paddr=0x000270bc vaddr=0x3ffb0000 size=0x02b00 ( 11008) load<br />I (800) boot: segment 3: paddr=0x00029bc4 vaddr=0x40080000 size=0x00400 (  1024) load<br />0x40080000: _iram_start at ??:?<br /><br />I (822) boot: segment 4: paddr=0x00029fcc vaddr=0x40080400 size=0x12cdc ( 77020) load<br />I (885) boot: segment 5: paddr=0x0003ccb0 vaddr=0x400c0000 size=0x00000 (     0) load<br />I (886) boot: segment 6: paddr=0x0003ccb8 vaddr=0x00000000 size=0x03350 ( 13136)<br />I (906) boot: segment 7: paddr=0x00040010 vaddr=0x400d0018 size=0x26ae8 (158440) map<br />0x400d0018: _flash_cache_start at ??:?<br /><br />I (932) cpu_start: Pro cpu up.<br />I (943) cpu_start: Starting app cpu, entry point is 0x40080ec0<br />0x40080ec0: call_start_cpu1 at /home/gojimmypi/esp/esp-idf/components/esp32/./cpu_start.c:174<br /><br />I (0) cpu_start: App cpu up.<br />I (976) heap_alloc_caps: Initializing. RAM available for dynamic allocation:<br />I (998) heap_alloc_caps: At 3FFAE2A0 len 00001D60 (7 KiB): DRAM<br />I (1018) heap_alloc_caps: At 3FFB6418 len 00029BE8 (166 KiB): DRAM<br />I (1039) heap_alloc_caps: At 3FFE0440 len 00003BC0 (14 KiB): D/IRAM<br />I (1061) heap_alloc_caps: At 3FFE4350 len 0001BCB0 (111 KiB): D/IRAM<br />I (1082) heap_alloc_caps: At 400930DC len 0000CF24 (51 KiB): IRAM<br />I (1103) cpu_start: Pro cpu start user code<br />I (1161) cpu_start: Starting scheduler on PRO CPU.<br />Hello world!<br />I (201) cpu_start: Starting scheduler on APP CPU.<br />This is ESP32 chip with 2 CPU cores, WiFi/BT/BLE, silicon revision 0, 4MB external flash<br />Looping in 10 seconds...<br />Looping in 9 seconds...<br />Looping in 8 seconds...<br />Looping in 7 seconds...<br />Looping in 6 seconds...<br /></code></pre><br /><br />On Windows machine, my Y: drive is mapped to the root of the Ubuntu machine (using samba): <br /><pre><code><br />net use y: \\192.168.174.130\c$<br /></code></pre>Then in Windows Explorer, open VSCode from <br /><pre><code>Y:\home\gojimmypi\esp\hello_world\build</code></pre><br />Press F5 to debug! Tada!<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="https://1.bp.blogspot.com/-rMexlNBu5rw/WTsEjPVUZHI/AAAAAAAAAcU/2gV2j8AA1uIVRQxhVSASsPCOd4zt2KiugCLcB/s1600/VSCode_ESP32_Debug.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="852" data-original-width="1064" height="508" src="https://1.bp.blogspot.com/-rMexlNBu5rw/WTsEjPVUZHI/AAAAAAAAAcU/2gV2j8AA1uIVRQxhVSASsPCOd4zt2KiugCLcB/s640/VSCode_ESP32_Debug.PNG" width="640" /></a></div><br /><br /><br /><br />VSCode immediately fails with this error if the last line is included in launch.json as noted for gdbinit: (so don't add it that last "c" command)<br /><div class="separator" style="clear: both; text-align: left;"><a href="https://1.bp.blogspot.com/-7qdw6-qGY4U/WTsD7lNZcxI/AAAAAAAAAcM/OTzViKLFjXA-TWGrE7bV_Dbkiv13T6-mQCLcB/s1600/gdbinit.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="185" data-original-width="716" height="164" src="https://1.bp.blogspot.com/-7qdw6-qGY4U/WTsD7lNZcxI/AAAAAAAAAcM/OTzViKLFjXA-TWGrE7bV_Dbkiv13T6-mQCLcB/s640/gdbinit.PNG" width="640" /></a></div><br /><br /><br /><pre><code>Unable to start debugging. Unexpected GDB output from command "-interpreter-exec console "c"".<br /></code></pre><br /><br /><pre><code>1: (138) LaunchOptions<locallaunchoptions 1:="" exearguments="" exepath="Y:\home\gojimmypi\esp\hello_world\build\hello-world.elf" launchoptions="" midebuggerpath="C:/msys32/opt/xtensa-esp32-elf/bin/xtensa-esp32-elf-gdb.exe" waitdynamiclibload="false" workingdirectory="Y:\home\gojimmypi\esp\hello_world\build\" xmlns="http://schemas.microsoft.com/vstudio/MDDDebuggerOptions/2014"><br />1: (143) LaunchOptions    <setupcommands><br />1: (143) LaunchOptions        <command description="Enable pretty-printing for gdb" ignorefailures="true"></command>-enable-pretty-printing<br />1: (144) LaunchOptions        <command description="" ignorefailures="false"></command>file 'Y:/home/gojimmypi/esp/hello_world/build/hello-world.elf'<br />1: (144) LaunchOptions        <command description="" ignorefailures="false"></command>target remote 192.168.174.130:3333<br />1: (144) LaunchOptions        <command description="" ignorefailures="false"></command>monitor reset halt<br />1: (144) LaunchOptions        <command description="" ignorefailures="false"></command>thb app_main<br />1: (144) LaunchOptions        <command description="" ignorefailures="false"></command>x $a1=0<br />1: (144) LaunchOptions        <command description="" ignorefailures="false"></command>c<br />1: (144) LaunchOptions    </setupcommands><br />1: (144) LaunchOptions</locallaunchoptions><br />1: (176) Starting: "C:/msys32/opt/xtensa-esp32-elf/bin/xtensa-esp32-elf-gdb.exe" --interpreter=mi<br />1: (189) DebuggerPid=22492<br />1: (216) -&gt;=thread-group-added,id="i1"<br />1: (217) -&gt;~"GNU gdb (crosstool-NG crosstool-ng-1.22.0-61-gab8375a) 7.10\n"<br />1: (217) -&gt;~"Copyright (C) 2015 Free Software Foundation, Inc.\n"<br />1: (217) -&gt;~"License GPLv3+: GNU GPL version 3 or later <http: gnu.org="" gpl.html="" licenses="">\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\n"<br />1: (217) -&gt;~"This GDB was configured as \"--host=i686-host_pc-mingw32 --target=xtensa-esp32-elf\".\nType \"show configuration\" for configuration details."<br />1: (217) -&gt;~"\nFor bug reporting instructions, please see:\n"<br />1: (217) -&gt;~"<http: bugs="" gdb="" software="" www.gnu.org="">.\n"<br />1: (217) -&gt;~"Find the GDB manual and other documentation resources online at:\n<http: documentation="" gdb="" software="" www.gnu.org="">.\n"<br />1: (217) -&gt;~"For help, type \"help\".\n"<br />1: (217) -&gt;~"Type \"apropos word\" to search for commands related to \"word\".\n"<br />1: (217) -&gt;(gdb)<br />1: (222) <-1001-gdb-set -="" 1:="" on="" target-async="">1001^done<br />1: (228) -&gt;(gdb)<br />1: (229) 1001: elapsed time 6<br />1: (234) <-1002-enable-pretty-printing -="" 1:="">1002^done<br />1: (239) -&gt;(gdb)<br />1: (239) 1002: elapsed time 5<br />1: (241) <-1003-interpreter-exec -="" 1:="" build="" console="" esp="" file="" gojimmypi="" hello-world.elf="" hello_world="" home="">~"Reading symbols from Y:/home/gojimmypi/esp/hello_world/build/hello-world.elf..."<br />1: (274) -&gt;~"done.\n"<br />1: (275) -&gt;1003^done<br />1: (275) -&gt;(gdb)<br />1: (275) 1003: elapsed time 34<br />1: (275) <-1004-interpreter-exec -="" 192.168.174.130:3333="" 1:="" console="" remote="" target="">~"Remote debugging using 192.168.174.130:3333\n"<br />1: (305) -&gt;=thread-group-started,id="i1",pid="42000"<br />1: (305) -&gt;=thread-created,id="1",group-id="i1"<br />1: (307) -&gt;~"0x00000000 in ?? ()\n"<br />1: (307) -&gt;*stopped,frame={addr="0x00000000",func="??",args=[]},thread-id="1",stopped-threads="all"<br />1: (309) -&gt;1004^done<br />1: (309) -&gt;(gdb)<br />1: (318) 1004: elapsed time 42<br />1: (319) <-1005-thread-info -="" 1:="" 1="">1005^done,threads=[{id="1",target-id="Remote target",frame={level="0",addr="0x00000000",func="??",args=[]},state="stopped"}]<br />1: (329) -&gt;(gdb)<br />1: (330) 1005: elapsed time 11<br />1: (330) <-1006-interpreter-exec -="" 1:="" console="" e="" halt="" monitor="" reason="" reset="" started="" thread:="" thread="" threadid="" type="">@"JTAG tap: esp32.cpu0 tap/device found: 0x120034e5 (mfg: 0x272 (Tensilica), part: 0x2003, ver: 0x1)\n"<br />1: (366) -&gt;@"JTAG tap: esp32.slave tap/device found: 0x120034e5 (mfg: 0x272 (Tensilica), part: 0x2003, ver: 0x1)\n"<br />1: (490) -&gt;@"Target halted. PRO_CPU: PC=0x400D0E1C (active)    APP_CPU: PC=0x00000000 \n"<br />1: (500) -&gt;@"esp32: target state: halted\n"<br />1: (542) -&gt;@"esp32: Debug controller was reset (pwrstat=0x5F, after clear 0x0F).\n"<br />1: (542) -&gt;@"esp32: Core was reset (pwrstat=0x5F, after clear 0x0F).\n"<br />1: (676) -&gt;@"Target halted. PRO_CPU: PC=0x5000004B (active)    APP_CPU: PC=0x00000000 \n"<br />1: (691) -&gt;@"esp32: target state: halted\n"<br />1: (740) -&gt;@"esp32: Core was reset (pwrstat=0x1F, after clear 0x0F).\n"<br /></-1006-interpreter-exec></-1005-thread-info></-1004-interpreter-exec></-1003-interpreter-exec></-1002-enable-pretty-printing></-1001-gdb-set></http:></http:></http:></code></pre><br />Even when things seem to be going well, eventually some errors are encountered. If you try to debug and nothing happens, it may be because there are too many breakpoints. The limit is TWO! But perhaps you don't know / remember you even have breakpoints, but see this in the View - Debug Console <br /><pre><code><br />1: (1048) <-1020-interpreter-exec -="" 1:="" console="" info="" sharedlibrary="">~"No shared libraries loaded at this time.\n"<br />1: (1051) -&gt;1020^done<br />1: (1051) -&gt;(gdb)<br />1: (1051) 1020: elapsed time 3<br />E output: {"category":"console","output":"Loaded 'shared libraries loaded at this time.'. Cannot find or open the symbol file.\r\n","data":null,"type":"output"}<br />Loaded 'shared libraries loaded at this time.'. Cannot find or open the symbol file.<br />1: (1061) <-1021-thread-info -="" 1:="">1021^done,threads=[{id="1",target-id="Remote target",frame={level="0",addr="0x40000400",func="??",args=[]},state="stopped"}],current-thread-id="1"<br />1: (1072) -&gt;(gdb)<br />1: (1072) 1021: elapsed time 11<br />1: (1078) <-1022-stack-list-frames -="" 0="" 1000="" 1:="">1022^done,stack=[frame={level="0",addr="0x40000400",func="??"}]<br />1: (1083) -&gt;(gdb)<br />1: (1083) 1022: elapsed time 4<br />1: (1086) <--exec-continue -="" 1:="">^error,msg="Warning:\nCannot insert breakpoint 3.\nCannot access memory at address 0x400f4d55\nCannot insert breakpoint 4.\nCannot access memory at address 0x400f4d75\n"<br />1: (1104) -&gt;(gdb)<br />E output: {"category":"stderr","output":"ERROR: Warning:\nCannot insert breakpoint 3.\nCannot access memory at address 0x400f4d55\nCannot insert breakpoint 4.\nCannot access memory at address 0x400f4d75\n\r\n","data":null,"type":"output"}<br />ERROR: Warning:<br />Cannot insert breakpoint 3.<br />Cannot access memory at address 0x400f4d55<br />Cannot insert breakpoint 4.<br />Cannot access memory at address 0x400f4d75<br /></--exec-continue></-1022-stack-list-frames></-1021-thread-info></-1020-interpreter-exec></code></pre>To resolve this, click on Debug - Remove All Breakpoints in VSCode.