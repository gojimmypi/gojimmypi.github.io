---
layout: post
title: 'VSCode JTAG Debugging of ESP32 - Part 1 '
date: '2017-05-25T17:40:00.003-07:00'
author: gojimmypi
tags: 
modified_time: '2017-06-09T17:24:02.725-07:00'
blogger_id: tag:blogger.com,1999:blog-4109066286647243251.post-4275580232239081572
blogger_orig_url: https://gojimmypi.blogspot.com/2017/05/vscode-jtag-debugging-of-esp32-part-1.html
---

(last edited June 2, 2017 - added WSL/Ubuntu info, but not working: JTAG device not recognized in WSL "Error: libusb_init() failed with LIBUSB_ERROR_OTHER"). I opened&nbsp;<a href="https://github.com/Microsoft/BashOnWindows/issues/2185">Bash On Windows github issue #2185</a>&nbsp;for this.<br /><br />These instructions are only for Ubuntu in stand-alone (or VM) machine; not (yet) for WSL/Ubuntu on Windows.<br /><br />To debug in VSCode, I am using the&nbsp;<a href="https://code.visualstudio.com/docs/languages/cpp">C/C++ for VSCode Extension</a> along with an Olimex ARM-USB-OCD-H JTAG debugger. There are 2 mains parts: installing (covered here) and debug setup (covered in part 2). I also show the wiring connections <a href="{{ site.baseurl }}{% post_url 2017-03-17-jtag-debugging-for-esp32 %}">here</a>.<br /><div><br />If you already have the toolchain installed and <a href="{{ site.baseurl }}{% post_url 2017-05-25-vscode-remote-jtag-debugging-of-esp32 %}">want to simply debug, see step 2</a>!<br /><br />I've also added a&nbsp;<a href="{{ site.baseurl }}{% post_url 2017-06-09-vscode-jtag-debugging-of-esp32-part-3 %}">step 3 using ESP WIP OpenOCD</a>.<br /><br /></div>In order to get VSCode debugging the ESP32, it is probably a good idea to first get regular gdb debugging working. Although I'd like to do this fully in Windows, I start with an Ubuntu VM and use <a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/">PuTTY SSH and Telnet Client</a> to connect. (see tip below on CR vs CRLF in VSCode)<br /><br />I started with the esp-idf instructions&nbsp;<a href="http://esp-idf.readthedocs.io/en/latest/get-started/linux-setup.html">http://esp-idf.readthedocs.io/en/latest/get-started/linux-setup.html</a>&nbsp;with release 2.1 from <a href="https://github.com/espressif/esp-idf">https://github.com/espressif/esp-idf</a>. Once the toolchain is installed, there's also a special version of OpenOCD here:&nbsp;<a href="https://github.com/espressif/openocd-esp32">https://github.com/espressif/openocd-esp32</a><br /><br /><br />Nothing new here not presented in espressif instructions; so in brief... basically for the esp-idf:<br /><pre><code><br /># see https://github.com/espressif/esp-idf.git<br /><br />sudo apt-get install git wget make libncurses-dev flex bison gperf python python-serial<br /><br /># download the toolchain, in this case the 64-bit linux version 1.22.0-61-gab8375a-5.2.0<br />mkdir -p ~/Downloads<br />cd ~/Downloads/<br />wget https://dl.espressif.com/dl/xtensa-esp32-elf-linux64-1.22.0-61-gab8375a-5.2.0.tar.gz<br /><br /># put the download into the ~/esp/xtensa-esp32-elf/ directory<br />mkdir -p ~/esp<br />cd ~/esp<br />tar -xzf ~/Downloads/xtensa-esp32-elf-linux64-1.22.0-61-gab8375a-5.2.0.tar.gz<br /><br /># get the esp-idf from github, don't forget the --recursive !!<br />mkdir -p ~/esp<br />cd ~/esp<br />git clone --recursive https://github.com/espressif/esp-idf.git<br /><br /><br />export PATH=$PATH:$HOME/esp/xtensa-esp32-elf/bin<br /></code></pre><br />if installing on WSL (Ubuntu on Windows), I needed to also install:<br /><br /><pre><code>sudo apt-get install libtool<br />sudo apt-get install autotools-dev  <br />sudo apt-get install automake # needed for aclocal<br />sudo apt-get install pkg-config # needed to solve error: configure.ac:12: error: possibly undefined macro: AC_MSG_WARN<br />sudo apt-get install libusb-1.0 # otherwise No package 'libusb-1.0' found<br /></code></pre><br />then for the openocd-32; make sure you do not have a regular distro version of openocd installed, if you do:  <br /><pre><code>sudo apt-get remove openocd<br /></code></pre><br />Here too, just restating the instructions from&nbsp;<a href="https://github.com/espressif/openocd-esp32">https://github.com/espressif/openocd-esp32</a>:<br /><pre><code>mkdir -p ~/workspace<br />cd ~/workspace<br />git clone --recursive https://github.com/espressif/openocd-esp32.git<br />sudo apt-get install make libtool pkg-config autoconf automake texinfo<br />sudo apt-get install libusb-1.0<br />cd openocd-esp32<br />./bootstrap<br />./configure<br /></code></pre><br />the default configure should show this when done:<br /><br /><pre><code>libjaylink configuration summary:<br /> - Package version ................ 0.1.0<br /> - Library version ................ 0:0:0<br /> - Installation prefix ............ /usr/local<br /> - Building on .................... x86_64-pc-linux-gnu<br /> - Building for ................... x86_64-pc-linux-gnu<br /><br /><br /><br />OpenOCD configuration summary<br />--------------------------------------------------<br />MPSSE mode of FTDI based devices        yes (auto)<br />Segger J-Link JTAG Programmer           yes (auto)<br />ST-Link JTAG Programmer                 yes (auto)<br />TI ICDI JTAG Programmer                 yes (auto)<br />Keil ULINK JTAG Programmer              yes (auto)<br />Altera USB-Blaster II Compatible        yes (auto)<br />Versaloon-Link JTAG Programmer          yes (auto)<br />OSBDM (JTAG only) Programmer            yes (auto)<br />eStick/opendous JTAG Programmer         yes (auto)<br />Andes JTAG Programmer                   yes (auto)<br />USBProg JTAG Programmer                 no<br />Raisonance RLink JTAG Programmer        no<br />Olimex ARM-JTAG-EW Programmer           no<br />CMSIS-DAP Compliant Debugger            no<br /></code></pre><br />if installing in WSL, the only difference I saw: <br /><pre><code><br /> - Building on .................... x86_64-unknown-linux-gnu<br /> - Building for ................... x86_64-unknown-linux-gnu<br /></code></pre><div>continue with:</div><pre><code><br />make<br />sudo make install<br />openocd<br /></code></pre>The make takes a rather long time. I did observe a couple of errors/warnings on WSL (didn't notice on linux). Seems to be only related to docs. Note the "makeinfo missing": <br /><pre><code>Making install in doc<br />make[1]: Entering directory `/home/gojimmypi/workspace/openocd-esp32/doc'<br />restore=: &amp;&amp; backupdir=".am$$" &amp;&amp; \<br />        am__cwd=`pwd` &amp;&amp; CDPATH="${ZSH_VERSION+.}:" &amp;&amp; cd . &amp;&amp; \<br />        rm -rf $backupdir &amp;&amp; mkdir $backupdir &amp;&amp; \<br />        if (echo makeinfo missing; true --version) &gt;/dev/null 2&gt;&amp;1; then \<br />          for f in openocd.info openocd.info-[0-9] openocd.info-[0-9][0-9] openocd.i[0-9] openocd.i[0-9][0-9]; do \<br />            if test -f $f; then mv $f $backupdir; restore=mv; else :; fi; \<br />          done; \<br />        else :; fi &amp;&amp; \<br />        cd "$am__cwd"; \<br />        if echo makeinfo missing; true   -I . \<br />         -o openocd.info openocd.texi; \<br />        then \<br />          rc=0; \<br />          CDPATH="${ZSH_VERSION+.}:" &amp;&amp; cd .; \<br />        else \<br />          rc=$?; \<br />          CDPATH="${ZSH_VERSION+.}:" &amp;&amp; cd . &amp;&amp; \<br />          $restore $backupdir/* `echo "./openocd.info" | sed 's|[^/]*$||'`; \<br />        fi; \<br />        rm -rf $backupdir; exit $rc<br />makeinfo missing<br />make[2]: Entering directory `/home/gojimmypi/workspace/openocd-esp32/doc'<br />make[2]: Nothing to be done for `install-exec-am'.<br />restore=: &amp;&amp; backupdir=".am$$" &amp;&amp; \<br />        am__cwd=`pwd` &amp;&amp; CDPATH="${ZSH_VERSION+.}:" &amp;&amp; cd . &amp;&amp; \<br />        rm -rf $backupdir &amp;&amp; mkdir $backupdir &amp;&amp; \<br />        if (echo makeinfo missing; true --version) &gt;/dev/null 2&gt;&amp;1; then \<br />          for f in openocd.info openocd.info-[0-9] openocd.info-[0-9][0-9] openocd.i[0-9] openocd.i[0-9][0-9]; do \<br />            if test -f $f; then mv $f $backupdir; restore=mv; else :; fi; \<br />          done; \<br />        else :; fi &amp;&amp; \<br />        cd "$am__cwd"; \<br />        if echo makeinfo missing; true   -I . \<br />         -o openocd.info openocd.texi; \<br />        then \<br />          rc=0; \<br />          CDPATH="${ZSH_VERSION+.}:" &amp;&amp; cd .; \<br />        else \<br />          rc=$?; \<br />          CDPATH="${ZSH_VERSION+.}:" &amp;&amp; cd . &amp;&amp; \<br />          $restore $backupdir/* `echo "./openocd.info" | sed 's|[^/]*$||'`; \<br />        fi; \<br />        rm -rf $backupdir; exit $rc<br />makeinfo missing<br /> /bin/mkdir -p '/usr/local/share/info'<br /> install-info --info-dir='/usr/local/share/info' '/usr/local/share/info/openocd.info'<br />This is not dpkg install-info anymore, but GNU install-info<br />See the man page for ginstall-info for command line arguments<br />install-info: No such file or directory for /usr/local/share/info/openocd.info<br /> /bin/mkdir -p '/usr/local/share/man/man1'<br /></code></pre>As we did not previously have <code>apt-get install openocd</code>, we should now see version 0.10 when running it.  Open On-Chip Debugger 0.10.0-dev-g372bb59 (2017-05-25-16:24) <br />copy the hello_world app:<br /><pre><code><br />export IDF_PATH=~/esp/esp-idf<br />cd ~/esp<br />cp -r $IDF_PATH/examples/get-started/hello_world .<br />cd ~/esp/hello_world<br />make menuconfig<br /></code></pre><br />if you have a hard time with the config window on WSL, try resizing the [Bash on Ubuntu] Winbdows size (typically smaller). Hit arrows up &amp; down to screen refresh. If you see the problem you'll understand. If not - then there's no problem! :) <br /><br />next, edit <code>~/workspace/openocd-esp32/tcl/interface/ftdi/olimex-arm-usb-ocd-h.cfg</code><br /><div>to add the <code>adapter_khz 1000</code> line (I saved mine to a file called <code>olimex-arm-usb-ocd-h-1MHz.cfg</code>):&nbsp;</div><pre><code>cd ~/workspace/openocd-esp32/tcl/interface/ftdi/<br />cp olimex-arm-usb-ocd-h.cfg  olimex-arm-usb-ocd-h-1MHz.cfg<br />nano olimex-arm-usb-ocd-h-1MHz.cfg<br /></code></pre><br /><pre><code>#<br /># Olimex ARM-USB-OCD-H<br />#<br /># http://www.olimex.com/dev/arm-usb-ocd-h.html<br />#<br />interface ftdi<br />ftdi_device_desc "Olimex OpenOCD JTAG ARM-USB-OCD-H"<br />ftdi_vid_pid 0x15ba 0x002b<br />ftdi_layout_init 0x0908 0x0b1b<br />ftdi_layout_signal nSRST -oe 0x0200<br />ftdi_layout_signal nTRST -data 0x0100<br />ftdi_layout_signal LED -data 0x0800 <br /><br />adapter_khz 1000<br /></code></pre>I also slightly modified my esp32.cfg file (thanks @ba0sh1 <a href="http://ba0sh1.com/">http://ba0sh1.com/</a>)   <br /><pre><code>cd ~/workspace/openocd-esp32/tcl/target/<br />cp esp32.cfg ESP32-RTOS-none.cfg</code></pre>just one change needed to set ESP32_RTOS none, but the whole file shown for reference.<br /><br />As a reminder, don't try to uncomment a setting and leave a comment at the end of the same line. I saved mine to: ~/workspace/openocd-esp32/tcl/target/ESP32-RTOS-none.cfg  <br /><pre><code><br />#With no variables set, openocd will configure JTAG for the two cores of the ESP32 and<br />#will not automatic RTOS detection. This can be be adjusted:<br /><br />#set ESP32_ONLYCPU 1        # Only configure the PRO CPU<br />#set ESP32_ONLYCPU 2        # Only configure the APP CPU<br /><br /># Disable RTOS support<br />set ESP32_RTOS none        <br /><br />#set ESP32_RTOS freertos    # Force RTOS to be FreeRTOS<br /><br />if { [info exists CHIPNAME] } {<br /> set _CHIPNAME $CHIPNAME<br />} else {<br /> set _CHIPNAME esp32<br />}<br /><br />if { [info exists CPUTAPID] } {<br /> set _CPUTAPID $CPUTAPID<br />} else {<br /> set _CPUTAPID 0x120034e5<br />}<br /><br />if { [info exists ESP32_RTOS] } {<br /> set _RTOS "$ESP32_RTOS"<br />} else {<br /> set _RTOS "auto"<br />}<br /><br />if { [info exists ESP32_ONLYCPU] } {<br /> set _ONLYCPU $ESP32_ONLYCPU<br />} else {<br /> set _ONLYCPU 3<br />}<br /><br />proc esp_core_halt { tgt } {<br /> #We need to disable the watchdogs here.<br /> #TIMG1 WDT<br /> $tgt mww 0x3FF5F064 0x50D83AA1<br /> $tgt mww 0x3FF5F048 0x0<br /> #TIMG2 WDT<br /> $tgt mww 0x3FF60064 0x50D83AA1<br /> $tgt mww 0x3FF60048 0x0<br /> #RTC WDT<br /> #ToDo: Figure out how to kill the RTC WDT<br />}<br /><br />proc configure_esp32_core { TGT } {<br /> $TGT configure -event halted [list esp_core_halt $TGT]<br />}<br /><br />#Change the name of the CPU taps depending on if it's enabled or not. This way, the user<br />#gets immediate feedback in the openocd logs.<br />if { $_ONLYCPU == "1" } {<br /> set _CPU0NAME cpu0<br /> set _CPU1NAME ignored<br />} elseif { $_ONLYCPU == "2" } {<br /> set _CPU0NAME ignored<br /> set _CPU1NAME cpu1<br />} else {<br /> set _CPU0NAME cpu0<br /> set _CPU1NAME cpu1<br />}<br /><br />#Do add both taps, even if one of the CPUs is disabled.<br />jtag newtap $_CHIPNAME $_CPU0NAME -irlen 5 -expected-id $_CPUTAPID<br />jtag newtap $_CHIPNAME $_CPU1NAME -irlen 5 -expected-id $_CPUTAPID<br />set _TARGETNAME1 $_CHIPNAME.cpu1<br />set _TARGETNAME2 $_CHIPNAME.cpu0<br /><br />if { $_ONLYCPU != 2 } {<br /> if { $_RTOS == "none" } {<br />  target create $_TARGETNAME2 esp108 -endian little -chain-position $_TARGETNAME2<br /> } else {<br />  target create $_TARGETNAME2 esp108 -endian little -chain-position $_TARGETNAME2 -rtos $_RTOS<br /> }<br /> configure_esp32_core $_TARGETNAME2<br />}<br />if { $_ONLYCPU != 1 } {<br /> if { $_RTOS == "none" } {<br /> target create $_TARGETNAME1 esp108 -endian little -chain-position $_TARGETNAME1<br /> } else {<br /> target create $_TARGETNAME1 esp108 -endian little -chain-position $_TARGETNAME1 -rtos $_RTOS<br /> }<br /> if { $_ONLYCPU != 3 } {<br />  configure_esp32_core $_TARGETNAME1<br /> }<br />}<br /><br /><br />#Force hw breakpoints. Once we have a memory map, we can also allow software bps.<br />gdb_breakpoint_override hard<br /><br /><br /></code></pre><br /><h3>Tips and Suggestions:</h3><br />Note that when moving between Windows and Linux... if you use VSCode to create bash script files from Windows, there's a&nbsp;<a href="https://github.com/Microsoft/vscode/issues/26626">little issue with the LF vs CRLF settings</a>. (note the little LF in the status bar at the bottom of the screen). You really only want to save files with LF on Linux, not CRLF like on Windows. If you ignore this, you'll may see an err like&nbsp;<a href="https://askubuntu.com/questions/304999/not-able-to-execute-a-sh-file-bin-bashm-bad-interpreter">Not able to execute a .sh file: /bin/bash^M: bad interpreter</a>. The CRLF's are to blame. The linux dosa2unix utility might also be helpful.<br /><br /><h3>Is it working?&nbsp;</h3>See my <a href="https://gist.github.com/gojimmypi/c2f65d468573028908c3ad87ff1aca9c">gist</a> or use this set of commands:<br /><pre><code>export PATH=$PATH:$HOME/esp/xtensa-esp32-elf/bin<br />export IDF_PATH=~/esp/esp-idf<br /><br />cd  ~/workspace/openocd-esp32/tcl<br />sudo openocd -f interface/ftdi/olimex-arm-usb-ocd-h-1MHz.cfg -c "transport select jtag"  -f target/ESP32-RTOS-none.cfg<br /></code></pre><br /><a href="{{ site.baseurl }}{% post_url 2017-05-25-vscode-remote-jtag-debugging-of-esp32 %}">Continued in step 2...</a><br /><h3>Resources and Inspiration: </h3><ul><li><a href="http://esp-idf.readthedocs.io/en/latest/get-started/windows-setup.html">esp-idf - Standard Setup of Toolchain for Windows</a></li><li><a href="http://esp-idf.readthedocs.io/en/latest/get-started/index.html">esp-idf - Getting Started</a></li><li><a href="https://sourceware.org/gdb/onlinedocs/gdb/GDB_002fMI.html">The GDB/MI Interface</a></li><li><a href="https://github.com/FHFS/esp-idf-VSCode-template">https://github.com/FHFS/esp-idf-VSCode-template</a></li><li><a href="https://www.allaboutcircuits.com/technical-articles/getting-started-with-openocd-using-ft2232h-adapter-for-swd-debugging/">https://www.allaboutcircuits.com/technical-articles/getting-started-with-openocd-using-ft2232h-adapter-for-swd-debugging/</a></li><li><a href="http://openocd.org/doc-release/doxygen/FreeRTOS_8c_source.html">OpenOCD FreeRTOS source</a></li><li><a href="https://stackoverflow.com/questions/2420813/using-gdb-to-single-step-assembly-code-outside-specified-executable-causes-error">https://stackoverflow.com/questions/2420813/using-gdb-to-single-step-assembly-code-outside-specified-executable-causes-error</a></li><li><a href="https://forum.sparkfun.com/viewtopic.php?f=18&amp;t=35579">sparkfun forum - OpenOCD with Olimex ARM-USB-OCD-H</a></li><li><a href="https://github.com/espressif/openocd-esp32">https://github.com/espressif/openocd-esp32</a></li><li><a href="http://openocd.org/doc/html/Server-Configuration.html">http://openocd.org/doc/html/Server-Configuration.html</a></li><li><a href="https://www.olimex.com/forum/index.php?topic=5676.0">olimex forum - Olimex ARM-USB-OCD-H with OpenOCD - libusb_open() failed with LIBUSB_ERROR_NOT_S</a></li><li><a href="https://github.com/espressif/esp-idf/issues/303">[TW#12206] VSCode works really well. Worth adding setup instructions in to the docs?  #303 </a></li><li><a href="https://www.allaboutcircuits.com/technical-articles/getting-started-with-openocd-using-ft2232h-adapter-for-swd-debugging/">allaboutcircuits - Getting Started with OPENOCD Using FT2232H Adapter for SWD Debugging</a></li><li><a href="http://vedder.se/2012/12/debugging-the-stm32f4-using-openocd-gdb-and-eclipse/">Benjamin's robotics - Debugging the STM32F4 using openocd, gdb and Eclipse</a></li><li><a href="https://github.com/geomatsi/stm32-tests/blob/master/boards/stm32f103-mini/scripts/openocd-jlink-swd.cfg">custom board script example (JLINK SWD)</a></li></ul><div><h3>Interesting but not really related:</h3></div><ul><li><a href="https://gist.github.com/brainstorm/24e843ae0295ee1e41dff47c5b43a02c">https://gist.github.com/brainstorm/esp32_promisc.c </a></li></ul><br /><br />(this is still a work in progress, sorry for spelling / formatting / content)  <br /><br /><a href="{{ site.baseurl }}{% post_url 2017-05-25-vscode-remote-jtag-debugging-of-esp32 %}">Continued in step 2....</a>