---
layout: post
title: 'Programming the Lattice Semiconductor FPGA iCE40 Ultra Plus Breakout Board
  iCE40UP5K-B-EVN '
date: '2018-05-06T11:57:00.003-07:00'
author: gojimmypi
tags: 
modified_time: '2018-05-06T13:35:52.361-07:00'
thumbnail: https://2.bp.blogspot.com/-vx2WL4cgSeI/Wu9PwIYiPRI/AAAAAAAABdA/XsEQBxvYN8IOIDTv1cdHTogc9jYo5kAcwCLcBGAs/s72-c/Lattice%2BBoard.PNG
blogger_id: tag:blogger.com,1999:blog-4109066286647243251.post-4490052538635931429
blogger_orig_url: https://gojimmypi.blogspot.com/2018/05/FPGA-Programming-iCE40UP5K-B-EVN.html
---

FPGA programming the Lattice Semiconductor iCE40 Ultra Plus Breakout Board.<br /><div><br />(work in progress, come back soon)<br /><div><br /></div>TL;DR<br /><ul><li>The Diamond Lattice software is complex, difficult to use, and underwhelming.</li><li>The FTDI drivers are (as usual) dreadful to deal with.</li><li>Develop with iCEcube2; binary ends up in {project}_Implmnt\sbt\outputs\bitmap</li><li>Program with&nbsp;<a href="http://www.latticesemi.com/view_document?document_id=52187">Standalone 3.10 64-bit for Windows</a>&nbsp;programmer.</li><li>Sample code:&nbsp;<a href="https://github.com/gojimmypi/iCE40UP5k-blink">https://github.com/gojimmypi/iCE40UP5k-blink</a>&nbsp;(bin file <a href="https://github.com/gojimmypi/iCE40UP5k-blink/blob/master/blink_Implmnt/sbt/outputs/bitmap/top_bitmap.bin">here</a>)</li></ul>Lattice Semiconductor <a href="https://twitter.com/gojimmypi/status/989843784283271168?s=20">tweeted a "new low price" for their iCE40UP5k-SG48 breakout</a>&nbsp;that I simply could not resist. I've been wanting to learn FPGA programming for some time, and had recently taken the <a href="https://gojimmypi.blogspot.com/2018/02/first-fpga-test-drive-with-altera.html">Altera Cyclone IV for a test drive</a>. I was not super impressed with the Quartus software, so I was interested in seeing how well the Lattice Diamond software worked in comparison.</div><div><br /><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://2.bp.blogspot.com/-vx2WL4cgSeI/Wu9PwIYiPRI/AAAAAAAABdA/XsEQBxvYN8IOIDTv1cdHTogc9jYo5kAcwCLcBGAs/s1600/Lattice%2BBoard.PNG" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="499" data-original-width="646" height="307" src="https://2.bp.blogspot.com/-vx2WL4cgSeI/Wu9PwIYiPRI/AAAAAAAABdA/XsEQBxvYN8IOIDTv1cdHTogc9jYo5kAcwCLcBGAs/s400/Lattice%2BBoard.PNG" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Lattice iCE40UP board diagram from the <a href="http://www.latticesemi.com/view_document?document_id=51987">User Guide</a></td></tr></tbody></table><br /><br /></div><div>I initially<a href="https://twitter.com/gojimmypi/status/989866654183051264?s=20">&nbsp;tried to order the board from DigiKey</a>. I gave up fussing with their dreadful ordering UI/UX and instead I <a href="https://twitter.com/gojimmypi/status/991334899754844160?s=20">ordered it from Mouser</a>. (specifically <a href="https://www.mouser.com/ProductDetail/Lattice/iCE40UP5K-B-EVN?qs=KeU%2FaRU0YVWVQ39q7XFcHg%3D%3D">this iCE40UP5K-B-EVN item</a> on the Mouser web site). The device arrived about a week later.</div><div><br /></div><div>There was a (clearly hand-cut) quarter sheet of paper with instructions included with the board:<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="https://2.bp.blogspot.com/-m_cvJRUYrCA/Wu9F96bILmI/AAAAAAAABb0/EzCHu9SHjoMCEnROvkFCk68JNimXO9lgQCLcBGAs/s1600/Lattice%2BInsert%2B.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1600" data-original-width="1208" height="400" src="https://2.bp.blogspot.com/-m_cvJRUYrCA/Wu9F96bILmI/AAAAAAAABb0/EzCHu9SHjoMCEnROvkFCk68JNimXO9lgQCLcBGAs/s400/Lattice%2BInsert%2B.jpg" width="301" /></a></div><br />Mainly of interest are the links:<br /><br />&nbsp;&nbsp;<a href="http://www.latticesemi.com/ice40ultraplusbreakout">http://www.latticesemi.com/ice40ultraplusbreakout</a><br /><br />&nbsp; &nbsp; &nbsp; and<br /><br />&nbsp;&nbsp;<a href="http://www.latticesemi.com/software">http://www.latticesemi.com/software</a><br /><br />.. and the reminder to put the jumpers on J6 in the "vertical position" (perpendicular to the jumper at J7)<br /><br />Despite the seemingly simply instructions, my&nbsp;<a href="https://twitter.com/gojimmypi/status/992831289806868480?s=20">initial out of the box experience was dreadful</a>. Not only was the computer completely unable to connect to the board for the demo, but later once I was able to connect without the error, the demo didn't even work. I don't think my board shipped with the demo program installed, nor was I able to find the source code anywhere to try it.</div><div><br /></div><div>The first problem seems to have been the fact that I already had installed FTDI drivers for my ESP32 development some time ago (specifically the rather rare JESP32). This was apparent when *both* FTDI devices were listed at the bottom of device manager, and when looking at properties - both were configured as JTAG devices:</div><div><br /></div><div class="separator" style="clear: both; text-align: left;"><a href="https://1.bp.blogspot.com/-PD1N7ed8LSk/Wu8_YWupywI/AAAAAAAABa8/CVWdz2OVFSsnXqH1b5z2V-jh1xV5kcaKwCLcBGAs/s1600/LatticeJESP32%2BJTAG.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="286" data-original-width="539" height="211" src="https://1.bp.blogspot.com/-PD1N7ed8LSk/Wu8_YWupywI/AAAAAAAABa8/CVWdz2OVFSsnXqH1b5z2V-jh1xV5kcaKwCLcBGAs/s400/LatticeJESP32%2BJTAG.PNG" width="400" /></a></div><div><br /></div><div>Looking back, I suppose this makes sense, as the JESP32 that was previously installed has the normal&nbsp;<a href="https://twitter.com/ba0sh1/status/979894658749800448?s=20">order of the devices reversed</a>:</div><blockquote class="tr_bq">"<i>Yeah. I used FT2232H interface 0 for UART and interface 1 for JTAG. This is different from many other debuggers. Advantages being you get same /dev/ttyUSB0 UART like many other dev boards. Also (which I heard) you donâ€™t need to modify kext under OSX</i>" -&nbsp;<a href="https://twitter.com/ba0sh1">@ba0sh1</a></blockquote><div>Sadly when the Lattice iCEcube2 software installs, it does not configure the ports properly. I ended up manually removing the drivers, then manually installing them. I'm pretty sure when I revisit my JESP32, it will not work.<br /><br />I was unable to find any useful sample code for the iCE40UP5K. I eventually found this:<br /><br /><a href="https://github.com/cliffordwolf/icestorm/tree/master/examples/up5k_rgb">https://github.com/cliffordwolf/icestorm/tree/master/examples/up5k_rgb</a><br /><br />I was unable to program from the Lattice iCEcube2&nbsp;software, as there was no "Tool - Program" on my menu!<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="https://3.bp.blogspot.com/-w4pnx-_9CbQ/Wu9MS6FQFlI/AAAAAAAABco/aMUqp41JLacvpKMugGFWOQk44xaVoqJIACLcBGAs/s1600/Lattice%2BNo%2BProgram.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="530" data-original-width="803" height="263" src="https://3.bp.blogspot.com/-w4pnx-_9CbQ/Wu9MS6FQFlI/AAAAAAAABco/aMUqp41JLacvpKMugGFWOQk44xaVoqJIACLcBGAs/s400/Lattice%2BNo%2BProgram.PNG" width="400" /></a></div><br />I needed to download the "Standalone Diamond Programmer" from here:<br /><br /><a href="http://www.latticesemi.com/Products/DesignSoftwareAndIP/ProgrammingAndConfigurationSw/Programmer">http://www.latticesemi.com/Products/DesignSoftwareAndIP/ProgrammingAndConfigurationSw/Programmer</a><br /><br />Don't bother using the site search to find this! Seemingly every software item *except* the one you want will be listed in the hundreds of results. (yes, I mistakenly tried installing an older version, and the iCE40UP is not listed as a device). The version that worked for me was 3.10.0.111.2 (I manually installed this one, different than the one that came with Lattice Diamond install) Specifically this link:<br /><br /><a href="http://www.latticesemi.com/view_document?document_id=52187">Programmer Standalone 3.10 64-bit for Windows</a><br /><br />From the iCECube2 output, once a project is successfully compiled, the resulting file can be found in the log output near the end (see above). In my case, the bin file was found here:<br /><br /><span style="color: #ad6163;">C:/lscc/iCEcube2.2017.08/sbt_backend/Projects/blink/blink_Implmnt\sbt\outputs\bitmap</span><br /><br />Note the annoying, sloppy use of forward and back slashes. They will need to be edited in Windows, otherwise an error occurs when pasting in the path.<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="https://1.bp.blogspot.com/-uI4x7QJNeJw/Wu9eCj2_c0I/AAAAAAAABdc/INDAeHvil8Yd48gxrlzNwan83mGdfCutACLcBGAs/s1600/Lattice%2BProgram%2BSlash%2BError.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="374" data-original-width="674" height="220" src="https://1.bp.blogspot.com/-uI4x7QJNeJw/Wu9eCj2_c0I/AAAAAAAABdc/INDAeHvil8Yd48gxrlzNwan83mGdfCutACLcBGAs/s400/Lattice%2BProgram%2BSlash%2BError.PNG" width="400" /></a></div><br />Windows only likes back-slashes, so each will need to be individually changed. In my case, the default project ended up in:<br /><br />C:\lscc\iCEcube2.2017.08\sbt_backend\Projects\blink\blink_Implmnt\sbt\outputs\bitmap<br /><br />And the file needed (mysteriously) is prefixed with "top_". Select that bin file in the Diamond Programmer by clicking on the little 3 dot ellipsis button:<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="https://1.bp.blogspot.com/-CSDHkkH34b8/Wu9fpsegNBI/AAAAAAAABdw/U3ZQuDGqnbcSJ0waTLhRC4_ZQHA8jE2SgCLcBGAs/s1600/Lattice%2BProgrammer%2BBlink%2BParameters.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="136" data-original-width="614" height="87" src="https://1.bp.blogspot.com/-CSDHkkH34b8/Wu9fpsegNBI/AAAAAAAABdw/U3ZQuDGqnbcSJ0waTLhRC4_ZQHA8jE2SgCLcBGAs/s400/Lattice%2BProgrammer%2BBlink%2BParameters.PNG" width="400" /></a></div><br />It should pop up a dialog box like this:<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="https://2.bp.blogspot.com/-Q_mHzbqvVc0/Wu9eugQ-B7I/AAAAAAAABdk/5LVSJhu6v7QVs5LeWm4BigOip_eb-zohACLcBGAs/s1600/Diamond%2BProgrammer%2BLoad%2BFile.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="401" data-original-width="686" height="233" src="https://2.bp.blogspot.com/-Q_mHzbqvVc0/Wu9eugQ-B7I/AAAAAAAABdk/5LVSJhu6v7QVs5LeWm4BigOip_eb-zohACLcBGAs/s400/Diamond%2BProgrammer%2BLoad%2BFile.PNG" width="400" /></a></div><br />Note the device family is set to iCE40 Ultra Plus and the Device is iCE40UP5K.<br /><br />Double-click on the "Operation" column (or click the "Device Properties" button) and ensure these settings are in place:<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="https://3.bp.blogspot.com/-NMKAtrxjC0c/Wu9gjJfABhI/AAAAAAAABd8/YfzqDmwsC2oTIQ1uYVb9ohOFXyBTlMxOACLcBGAs/s1600/Lattice%2BDevice%2BProperties.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="347" data-original-width="530" height="261" src="https://3.bp.blogspot.com/-NMKAtrxjC0c/Wu9gjJfABhI/AAAAAAAABd8/YfzqDmwsC2oTIQ1uYVb9ohOFXyBTlMxOACLcBGAs/s400/Lattice%2BDevice%2BProperties.PNG" width="400" /></a></div><br />I saved my working project to GitHub here:&nbsp;<a href="https://github.com/gojimmypi/iCE40UP5k-blink">https://github.com/gojimmypi/iCE40UP5k-blink</a><br /><br />Once working, when viewing with <a href="https://zadig.akeo.ie/">Zadig</a>, this is what I see (note Interface 0 and Interface 1):<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="https://1.bp.blogspot.com/-ynFfk3k6rhs/Wu9B_GS-FlI/AAAAAAAABbc/_Hphgn01DiQHE64SQoHeYU1U8_h6QwQkACEwYBhgL/s1600/Lattice%2BZadig%2B0.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="261" data-original-width="582" height="143" src="https://1.bp.blogspot.com/-ynFfk3k6rhs/Wu9B_GS-FlI/AAAAAAAABbc/_Hphgn01DiQHE64SQoHeYU1U8_h6QwQkACEwYBhgL/s320/Lattice%2BZadig%2B0.JPG" width="320" /></a></div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;"><a href="https://2.bp.blogspot.com/-5b47zn4j25g/Wu9CA5u8-4I/AAAAAAAABbg/fcAUdcXLH780Yp7YnghUotTsEG_LvHfjQCEwYBhgL/s1600/Lattice%2BZadig%2B1.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="256" data-original-width="579" height="141" src="https://2.bp.blogspot.com/-5b47zn4j25g/Wu9CA5u8-4I/AAAAAAAABbg/fcAUdcXLH780Yp7YnghUotTsEG_LvHfjQCEwYBhgL/s320/Lattice%2BZadig%2B1.JPG" width="320" /></a></div><br />However programming is not always successful, even if the software finds the device:<br /><pre><code><br />INFO - Check XCF Project: The current XCF Project is valid.<br />INFO - Check XCF Project: The current XCF Project is valid.<br />INFO - Check configuration setup: Start.<br /><br />INFO - Check configuration setup: Successful (Ignored JTAG Connection Checking).<br /><br />INFO - Device1 iCE40UP5K: Fast Program<br /><br /><br /> "Device detection failed. Cannot continue."<br /><br />ERROR - Process Operation Failed.<br /><br />INFO - Elapsed time: 00 min : 00 sec<br /><br />ERROR - Operation: unsuccessful.<br /><br />ERROR - Programming failed.</code></pre><br />If the programming fails like this, try switching ports. One one computer (one that I had <i>not</i> installed JESP32 FTDI drivers)... I was able to program on the default "Port 0" (FTUSB-0) - on another computer (the one I previously <i>had </i>configured FTDI drivers, I had to change to "Port 1" (FTUSB-1) in order to program.<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="https://4.bp.blogspot.com/-6q9GHh7Rizw/Wu9Hj48CI1I/AAAAAAAABcE/eSSc79PYV8MMLtsEXLvLts2ocvGN7v4ywCEwYBhgL/s1600/Lattice%2BPort%2BSelect.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="269" data-original-width="325" height="330" src="https://4.bp.blogspot.com/-6q9GHh7Rizw/Wu9Hj48CI1I/AAAAAAAABcE/eSSc79PYV8MMLtsEXLvLts2ocvGN7v4ywCEwYBhgL/s400/Lattice%2BPort%2BSelect.PNG" width="400" /></a></div><br /><a href="https://twitter.com/gojimmypi/status/992947433503010816?s=20">In the end I was eventually successful</a>, but I don't think the iCE40UP5K is for everyone.<br /><br /><br /><br /><br /><br /><br /></div>